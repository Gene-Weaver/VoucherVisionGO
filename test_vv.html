<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoucherVision API Test - Improved Debugging</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
        button { background-color: #4285f4; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .error { color: #d32f2f; }
        .success { color: #388e3c; }
        .loading { color: #0288d1; }
        .debug-section { border-top: 1px solid #ddd; margin-top: 20px; padding-top: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .debug-section h3 { color: #9e9e9e; }
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 10px 15px; transition: 0.3s; color: black; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #ccc; }
        .tabcontent { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; }
        .tabcontent.active { display: block; }
        .checkbox-group { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>VoucherVision API Test</h1>
    
    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'FileUpload')">File Upload</button>
        <button class="tablinks" onclick="openTab(event, 'ImageUrl')">Image URL</button>
        <button class="tablinks" onclick="openTab(event, 'Settings')">Settings</button>
    </div>
    
    <div id="FileUpload" class="tabcontent active">
        <h2>Test with File Upload</h2>
        <div class="form-group">
            <label for="fileInput">Select an image file:</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        <button id="uploadButton">Upload and Process</button>
        <div id="fileResults"></div>
    </div>
    
    <div id="ImageUrl" class="tabcontent">
        <h2>Test with Image URL</h2>
        <div class="form-group">
            <label for="imageUrl">Image URL:</label>
            <input type="text" id="imageUrl" style="width: 100%;" placeholder="Enter image URL">
        </div>
        <div class="form-group">
            <button id="testUrlAvailability">Test URL Availability</button>
            <span id="urlTestResult"></span>
        </div>
        <button id="processUrlButton">Process URL</button>
        <div id="urlResults"></div>
    </div>
    
    <div id="Settings" class="tabcontent">
        <h2>API Settings</h2>
        <div class="form-group">
            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" value="oUxLwoODeKBBXp60VGUYovKaFSEYYobV" style="width: 300px;">
        </div>
        <div class="checkbox-group">
            <label>
                <input type="checkbox" id="ocrOnly"> OCR Only Mode
            </label>
        </div>
        <div class="form-group">
            <label>Engines:</label>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" name="engines" value="gemini-1.5-pro" checked> gemini-1.5-pro
                </label>
            </div>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" name="engines" value="gemini-2.0-flash" checked> gemini-2.0-flash
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="promptTemplate">Prompt Template:</label>
            <input type="text" id="promptTemplate" value="SLTPvM_default.yaml" style="width: 300px;">
        </div>
    </div>

    <div class="debug-section">
        <h3>Debug Information</h3>
        <div id="debugInfo"></div>
    </div>

    <script>
        // Tab functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].className = tabcontent[i].className.replace(" active", "");
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).className += " active";
            evt.currentTarget.className += " active";
        }
        
        // Logger function for debug info
        function logDebug(message, data = null) {
            const timestamp = new Date().toISOString();
            let logEntry = `<div><strong>${timestamp}</strong>: ${message}</div>`;
            
            if (data) {
                let dataStr;
                try {
                    dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                    logEntry += `<pre>${dataStr}</pre>`;
                } catch (e) {
                    logEntry += `<pre>Error stringifying data: ${e.message}</pre>`;
                }
            }
            
            $('#debugInfo').prepend(logEntry);
        }

        // Get selected engines
        function getSelectedEngines() {
            const engines = [];
            $('input[name="engines"]:checked').each(function() {
                engines.push($(this).val());
            });
            return engines;
        }

        // Test URL availability
        $('#testUrlAvailability').click(function() {
            const imageUrl = $('#imageUrl').val();
            if (!imageUrl) {
                $('#urlTestResult').html('<span class="error">Please enter a URL</span>');
                return;
            }

            $('#urlTestResult').html('<span class="loading">Testing...</span>');
            
            logDebug(`Testing URL availability: ${imageUrl}`);

            // Use fetch with CORS mode to test URL availability
            fetch(imageUrl, { 
                method: 'HEAD',
                mode: 'no-cors' // This is important for cross-origin requests
            })
            .then(() => {
                // If we get here, the URL exists and can be accessed
                $('#urlTestResult').html('<span class="success">URL is accessible!</span>');
                logDebug('URL test success');
                
                // Show image preview
                $('#urlResults').html(`
                    <div style="margin-top: 20px;">
                        <h3>Image Preview:</h3>
                        <img src="${imageUrl}" style="max-width: 100%; max-height: 300px;" />
                    </div>
                `);
            })
            .catch(error => {
                $('#urlTestResult').html(`<span class="error">Error accessing URL: ${error.message}</span>`);
                logDebug('URL test failed', error);
            });
        });

        // File upload test
        $('#uploadButton').click(function() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file first');
                return;
            }
            
            const file = fileInput.files[0];
            const apiKey = $('#apiKey').val();
            const ocrOnly = $('#ocrOnly').is(':checked');
            const engines = getSelectedEngines();
            const promptTemplate = $('#promptTemplate').val();
            
            if (engines.length === 0) {
                alert('Please select at least one engine');
                return;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            
            // Add each selected engine
            engines.forEach(engine => {
                formData.append('engines', engine);
            });
            
            // Add prompt template if specified
            if (promptTemplate) {
                formData.append('prompt', promptTemplate);
            }
            
            // Add OCR only mode if selected
            if (ocrOnly) {
                formData.append('ocr_only', 'true');
            }
            
            // Disable button during processing
            $('#uploadButton').prop('disabled', true).text('Processing...');
            $('#fileResults').html('<p class="loading">Processing... Please wait.</p>');
            
            logDebug('Starting file upload', {
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                apiKey: apiKey.substring(0, 5) + '...',
                ocrOnly: ocrOnly,
                engines: engines,
                promptTemplate: promptTemplate
            });
            
            // Log FormData contents for debugging
            const formDataEntries = [];
            for (const pair of formData.entries()) {
                formDataEntries.push({key: pair[0], value: pair[0] === 'file' ? pair[1].name : pair[1]});
            }
            logDebug('FormData contents', formDataEntries);
            
            $.ajax({
                type: 'POST',
                headers: {'X-API-Key': apiKey},
                url: 'https://vouchervision-go-738307415303.us-central1.run.app/process',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(data) {
                    logDebug('API response success', data);
                    $('#fileResults').html(`
                        <h3 class="success">Results:</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `);
                },
                error: function(xhr, status, error) {
                    const response = xhr.responseText || 'No response content';
                    logDebug('API response error', {
                        status: status,
                        error: error,
                        response: response,
                        statusCode: xhr.status,
                        headers: xhr.getAllResponseHeaders()
                    });
                    
                    $('#fileResults').html(`
                        <h3 class="error">Error:</h3>
                        <p>Status: ${status}</p>
                        <p>Status Code: ${xhr.status}</p>
                        <p>Error: ${error}</p>
                        <p>Response:</p>
                        <pre>${response}</pre>
                    `);
                },
                complete: function() {
                    // Re-enable button
                    $('#uploadButton').prop('disabled', false).text('Upload and Process');
                }
            });
            
            // Alternative using Fetch API
            /* 
            fetch('https://vouchervision-go-738307415303.us-central1.run.app/process', {
                method: 'POST',
                headers: {
                    'X-API-Key': apiKey
                },
                body: formData
            })
            .then(response => {
                logDebug('Fetch response', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: [...response.headers.entries()]
                });
                
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`API error ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                logDebug('API response success', data);
                $('#fileResults').html(`
                    <h3 class="success">Results:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `);
            })
            .catch(error => {
                logDebug('API response error', error);
                $('#fileResults').html(`
                    <h3 class="error">Error:</h3>
                    <p>${error.message}</p>
                `);
            })
            .finally(() => {
                // Re-enable button
                $('#uploadButton').prop('disabled', false).text('Upload and Process');
            });
            */
        });
        
        // URL processing test
        $('#processUrlButton').click(function() {
            const imageUrl = $('#imageUrl').val();
            if (!imageUrl) {
                alert('Please enter an image URL');
                return;
            }
            
            const apiKey = $('#apiKey').val();
            const ocrOnly = $('#ocrOnly').is(':checked');
            const engines = getSelectedEngines();
            const promptTemplate = $('#promptTemplate').val();
            
            if (engines.length === 0) {
                alert('Please select at least one engine');
                return;
            }
            
            // Disable button during processing
            $('#processUrlButton').prop('disabled', true).text('Processing...');
            $('#urlResults').html('<p class="loading">Processing... Please wait.</p>');
            
            logDebug('Starting URL processing', {
                imageUrl: imageUrl,
                apiKey: apiKey.substring(0, 5) + '...',
                ocrOnly: ocrOnly,
                engines: engines,
                promptTemplate: promptTemplate
            });
            
            const requestBody = {
                image_url: imageUrl,
                engines: engines,
                ocr_only: ocrOnly
            };
            
            if (promptTemplate) {
                requestBody.prompt = promptTemplate;
            }
            
            $.ajax({
                type: 'POST',
                headers: {
                    'X-API-Key': apiKey,
                    'Content-Type': 'application/json'
                },
                url: 'https://vouchervision-go-738307415303.us-central1.run.app/process-url',
                data: JSON.stringify(requestBody),
                dataType: 'json',
                success: function(data) {
                    logDebug('API response success', data);
                    $('#urlResults').html(`
                        <h3 class="success">Results:</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `);
                },
                error: function(xhr, status, error) {
                    const response = xhr.responseText || 'No response content';
                    logDebug('API response error', {
                        status: status,
                        error: error,
                        response: response,
                        statusCode: xhr.status,
                        headers: xhr.getAllResponseHeaders()
                    });
                    
                    $('#urlResults').html(`
                        <h3 class="error">Error:</h3>
                        <p>Status: ${status}</p>
                        <p>Status Code: ${xhr.status}</p>
                        <p>Error: ${error}</p>
                        <p>Response:</p>
                        <pre>${response}</pre>
                    `);
                },
                complete: function() {
                    // Re-enable button
                    $('#processUrlButton').prop('disabled', false).text('Process URL');
                }
            });
        });

        // Initialize the page
        $(document).ready(function() {
            logDebug('Page initialized');
        });
    </script>
</body>
</html>