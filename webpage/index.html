<!-- 
To test, in terminal run this to start a local server:
python -m http.server 8000

Then in a browser open:
http://localhost:8000/webpage/index.html 

OR 

http://localhost:8000/index.html 
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoucherVision API</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Make sure Mapbox JS and CSS are loaded -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <link rel="stylesheet" href="css/vouchervisiongo.css">
    <script>
        // Function to dynamically add Mapbox (optional, already in head)
        function addMapboxToHead() {
            if (!document.querySelector('script[src*="mapbox-gl.js"]')) {
                const mapboxScript = document.createElement('script');
                mapboxScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js';
                document.head.appendChild(mapboxScript);
            }
            if (!document.querySelector('link[href*="mapbox-gl.css"]')) {
                const mapboxCss = document.createElement('link');
                mapboxCss.rel = 'stylesheet';
                mapboxCss.href = 'https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css';
                document.head.appendChild(mapboxCss);
            }
        }
    </script>

</head>

<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="img/logo.png" alt="Logo" class="logo">
                <h2>VoucherVisionGO API</h2>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <ul>
                <li><a href="#" id="homeLink" class="active">Home</a></li>
                <li><a href="#" id="readmeLink">About</a></li>
                <li><a href="#" id="promptsLink">Available Prompts</a></li>
                <li><a href="#" id="changelogLink">Changelog</a></li>
                <li class="nav-right"><a href="#" id="signupLink">Sign up / Login</a></li>
            </ul>
        </div>

        <!-- README Content Section (initially hidden) -->
        <div id="readmeContent" class="readme-section" style="display: none;"></div>

        <!-- Prompts Content Section (initially hidden) -->
        <div id="promptsContent" class="prompts-section" style="display: none;">
            <iframe id="promptsFrame" src="about:blank" frameborder="0"></iframe>
        </div>

        <div id="changelogContent" class="changelog-section" style="display: none;">
            <!-- This will be populated by JS -->
        </div>

        <!-- Signup/Login Content Section (initially hidden) -->
        <div id="signupContent" class="signup-section" style="display: none;">
            <iframe id="signupFrame" src="about:blank" frameborder="0"></iframe>
        </div>

        <!-- Main App Content (initially visible) -->
        <div id="mainContent">
            <!-- Settings section moved above the tabs -->
            <div id="Settings" class="settings-panel">
                <h2>API Settings</h2>

                <!-- Authentication Method Selection -->
                <div class="form-group">
                    <label>Authentication Method:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="authMethod" value="apiKey" checked> API Key
                        </label>
                        <label>
                            <input type="radio" name="authMethod" value="token"> Auth Token
                        </label>
                    </div>
                </div>

                <!-- API Key Fields -->
                <div id="apiKeyFields" class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="text" id="apiKey" value="YOUR_API_KEY" readonly>
                    <!-- Buttons will be added by our JavaScript -->
                </div>

                <!-- Auth Token Fields -->
                <div id="tokenFields" class="form-group" style="display: none;">
                    <label for="authToken">Auth Token:</label>
                    <input type="text" id="authToken" placeholder="Enter your Firebase Authentication Token">
                    <button id="clearTokenButton" class="button"
                        style="background-color: #f44336; margin-left: 10px;">Clear Token</button>
                </div>

                <label>Selecting OCR Engine Options</label>
                <p class="help-text">Select one or two OCR engines below. Each engine has different capabilities and
                    performance characteristics.</p>
                <div
                    style="background-color: #e8f5e9; border: 1px solid #c8e6c9; border-left: 4px solid #4CAF50; border-radius: 4px; padding: 15px; margin: 15px 0;">
                    <p>About the models:</p>
                    <ul>
                        <li><strong>Gemini 2.5 Pro</strong>: Higher accuracy, especially for handwritten text, can
                            follow complex instructions, like parsing multiple species determinations. Can perform geolocation, 
                            search the internet to validate content, etc.
                        </li>
                        <li><strong>Gemini 2.0 Flash</strong>: Fast processing with good accuracy for most specimens
                        </li>
                        <li><strong>Gemini 1.5 Pro</strong>: Better at handwriting than Gemini 2.0 Flash, but will be
                            deprecated in 2025, slower and more expensive than Gemini 2.0 Flash.</li>
                        <li><strong>Gemini 2.5 Flash</strong>: A bit disappointing at the moment. Handwriting
                            performance seems worse than Gemini 2.0 Flash</li>
                        <li><strong>OCR Only</strong>: Extract text only (check box below)</li>
                    </ul>
                </div>

                <h3>OCR Engines (can select one or multiple):</h3>
                <div style="display: table; width: 100%; table-layout: fixed; margin-bottom: 20px;">
                    <div style="display: table-cell; width: 50%; padding-right: 20px; vertical-align: top;">
                        <style>
                            /* Tooltip container */
                            .custom-tooltip {
                                position: relative;
                                display: inline-block;
                            }

                            /* Tooltip text - hidden by default */
                            .custom-tooltip:hover::after {
                                content: attr(data-tooltip);
                                visibility: visible;
                                width: 240px;
                                background-color: #4CAF50;
                                color: #fff;
                                text-align: center;
                                padding: 5px 0;
                                border-radius: 6px;

                                /* Position the tooltip text */
                                position: absolute;
                                z-index: 100;
                                top: 0;
                                left: 110%;
                            }

                            /* Tooltip arrow */
                            .custom-tooltip:hover::before {
                                content: "";
                                visibility: visible;
                                position: absolute;
                                top: 50%;
                                right: -10px;
                                /* Position to the right of the element */
                                margin-top: -5px;
                                border-width: 5px;
                                border-style: solid;
                                border-color: transparent transparent transparent #4CAF50;
                                z-index: 101;
                            }
                        </style>
                        
                        <div class="checkbox-group">
                            <label class="custom-tooltip"
                                data-tooltip="The 2.5 models are currently Experimental models from Google, sometimes they fail to return OCR right now. That should get better later">
                                <input type="checkbox" name="engines" value="gemini-2.5-pro" unchecked> gemini-2.5-pro
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label class="custom-tooltip"
                                data-tooltip="Use this model. You can add another model for even better support">
                                <input type="checkbox" name="engines" value="gemini-2.0-flash" checked> gemini-2.0-flash
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label class="custom-tooltip"
                                data-tooltip="The 2.5 models are currently Experimental models from Google, sometimes they fail to return OCR right now. That should get better later">
                                <input type="checkbox" name="engines" value="gemini-2.5-flash" unchecked> gemini-2.5-flash
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label class="custom-tooltip"
                                data-tooltip="Will be deprecated sometime in 2025 (but it does perform well)">
                                <input type="checkbox" name="engines" value="gemini-1.5-pro" unchecked>gemini-1.5-pro
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label class="custom-tooltip"
                                data-tooltip="Very lightweight">
                                <input type="checkbox" name="engines" value="gemini-2.0-flash-lite" unchecked>gemini-2.0-flash-lite
                            </label>
                        </div>

                    </div>

                    <div style="margin-top: 0px;"> <!-- Aligned with the OCR Engines label -->
                        <div
                            style="background-color: #f8f8f8; border: 1px solid #ddd; border-radius: 4px; padding: 15px; width: 50%;">
                            <label>
                                <input type="checkbox" id="ocrOnly"> OCR Only Mode
                            </label>
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <div
                            style="background-color: #f8f8f8; border: 1px solid #ddd; border-radius: 4px; padding: 15px; width: 50%;">
                            <label>
                                <input type="checkbox" id="notebookMode"> Notebook Mode
                            </label>
                            <p class="help-text">Bypasses TextCollage and uses the uploaded image directly. Produces markdown files.</p>
                        </div>
                    </div>
                      
                </div>

                <h3>LLM Model for creating JSON:</h3>
                <p>Please use gemini-2.0-flash and reserve gemini-2.5-pro for the prompts that are optimized to take full advantage of its capabilities (e.g. SLTPvM_geolocate_flag_multispecimen.yaml).</p>
                <p>SLTPvM_geolocate_flag_multispecimen.yaml will flag sheets that have more than one specimen (barcodes) and will automatically geolocate specimens that lack GPS coordinates in the label text</p>
                <div style="display: table; width: 100%; table-layout: fixed; margin-bottom: 20px;">
                    <div style="display: table-cell; width: 50%; padding-right: 20px; vertical-align: top;">
                        <div class="radio-group">
                            <label class="custom-tooltip"
                                data-tooltip="Use this model">
                                <input type="radio" name="llm_model" value="gemini-2.5-pro"> gemini-2.5-pro
                            </label>
                        </div>
                        <div class="radio-group">
                            <label class="custom-tooltip"
                                data-tooltip="This model is a bit unpredictable">
                                <input type="radio" name="llm_model" value="gemini-2.5-flash"> gemini-2.5-flash
                            </label>
                        </div>
                        <div class="radio-group">
                            <label  class="custom-tooltip"
                                data-tooltip="Use this for bulk workloads">
                                <input type="radio" name="llm_model" value="gemini-2.0-flash" checked> gemini-2.0-flash
                            </label>
                        </div>
                        <div class="radio-group">
                            <label class="custom-tooltip"
                                data-tooltip="Disabled because it will be deprecated sometime in 2025 (but it does perform well)">
                                <input type="radio" name="llm_model" value="gemini-1.5-pro" disabled> gemini-1.5-pro
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3>World Flora Online (WFO) Validation:</h3>
                    <p class="help-text">Enable taxonomic validation against the World Flora Online database for plant specimens. This adds botanical name verification and taxonomic information to the results.</p>
                    <div class="checkbox-group">
                        <label class="custom-tooltip"
                            data-tooltip="Validates plant names against World Flora Online database and provides taxonomic corrections">
                            <input type="checkbox" id="includeWfo" name="include_wfo" value="true"> Include WFO validation
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3 for="promptTemplate">Prompt Template:</h3>
                    <input type="text" id="promptTemplate" value="SLTPvM_default_v2.yaml">
                    <!-- This is where the prompts buttons will be added -->
                    <div id="promptButtonsArea"></div>
                </div>

                <div class="form-group">
                    <button id="testCorsButton" class="button">Test CORS Support</button>
                    <div id="corsStatus" class="status-display"></div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="FileUpload">File Upload</div>
                <div class="tab" data-tab="ImageUrl">Image URL</div>
                <div class="tab" data-tab="BatchUrls">Batch URLs</div>
                <div class="tab" data-tab="BatchFolder">Batch Folder</div>
            </div>

            <div id="FileUpload" class="tab-content active">
                <h2>Test with File Upload</h2>
                <!-- ... File Upload Input/Button ... -->
                 <div class="form-group file-input-container">
                     <label for="fileInput">Select an image file:</label>
                     <input type="file" id="fileInput" accept="image/*">
                     <img id="imagePreview" class="file-preview" src="#" alt="Image Preview">
                 </div>
                 <button id="uploadButton" class="button">Upload and Process</button>
                 <div id="fileResults" class="results">
                    <div id="fileJsonResults" class="json-results"></div> <!-- Results appear here -->
                 </div>
            </div>

            <div id="ImageUrl" class="tab-content">
                <h2>Test with Image URL</h2>
                <div class="form-group">
                    <label for="imageUrl">Image URL:</label>
                    <!-- <input type="text" id="imageUrl" value="https://medialib.naturalis.nl/file/id/L.3800382/format/large" placeholder="Enter image URL"> -->
                    <input type="text" id="imageUrl"
                        value="https://quod.lib.umich.edu/cgi/i/image/api/image/herb00ic:1500329:MICH-V-1500329/full/res:0/0/native.jpg"
                        placeholder="Enter image URL">
                </div>
                <div class="form-group">
                    <button id="testUrlAvailability" class="button">Test URL Availability</button>
                    <span id="urlTestResult"></span>
                </div>
                <button id="processUrlButton" class="button">Process URL</button>
                <div id="urlResults" class="results">
                    <div id="urlJsonResults" class="json-results"></div>
                </div>
            </div>

            <!-- New tab for Batch URL Processing -->
            <div id="BatchUrls" class="tab-content">
                <h2>Batch Process URLs</h2>
                <div class="form-group">
                    <label>Upload URL List:</label>
                    <p class="help-text">Upload a text file (.txt) with one URL per line or a CSV file (.csv) with URLs
                        in a column.</p>
                    <input type="file" id="batchUrlFileInput" accept=".txt,.csv">
                    <div id="urlFilePreview" class="file-list"></div>
                </div>

                <div class="form-group">
                    <label for="csvUrlColumn">CSV URL Column Name (if using CSV):</label>
                    <input type="text" id="csvUrlColumn" value="url" placeholder="Enter column name containing URLs">
                </div>

                <div class="form-group">
                    <p>Example CSV file format:</p>
                    <table class="csv-example">
                        <thead>
                            <tr>
                                <th>url</th>
                                <th>description</th>
                                <th>category</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>https://example.com/image1.jpg</td>
                                <td>Specimen 1</td>
                                <td>Category A</td>
                            </tr>
                            <tr>
                                <td>https://example.com/image2.jpg</td>
                                <td>Specimen 2</td>
                                <td>Category B</td>
                            </tr>
                            <tr>
                                <td>https://example.com/image3.jpg</td>
                                <td>Specimen 3</td>
                                <td>Category C</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="saveBatchToCsv" checked disabled> Save results to CSV
                        </label>
                    </div>
                </div>

                <div class="batch-controls">
                    <div class="concurrency-selector">
                        <label for="concurrencySlider">Concurrent requests:</label>
                        <input type="range" id="concurrencySlider" min="1" max="32" value="8">
                        <span id="concurrencyValue">8</span>
                    </div>
                    <button id="processBatchUrlsButton" class="button">Process URLs</button>
                </div>

                <div class="batch-progress" style="display: none;">
                    <div class="progress-bar"></div>
                    <div class="progress-stats">
                        <span class="progress-text">Processing...</span>
                        <span class="progress-count">0/0</span>
                    </div>
                </div>

                <div class="url-preview-gallery"></div>
                <div id="batchUrlResults" class="batch-results">
                    <div id="batchUrlJsonResults" class="json-results"></div>
                </div>
            </div>

            <!-- New tab for Batch Folder Processing -->
            <div id="BatchFolder" class="tab-content">
                <h2>Batch Process Local Images</h2>

                <div class="folder-drop-zone" id="imageFolderDropZone">
                    <p>Drop image files here or</p>
                    <input type="file" id="imageFolderInput" webkitdirectory directory multiple accept="image/*">
                    <div id="selectedFilesList" class="file-list"></div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="saveImageBatchToCsv" checked disabled> Save results to CSV
                        </label>
                    </div>
                </div>

                <div class="batch-controls">
                    <div class="concurrency-selector">
                        <label for="imageConcurrencySlider">Concurrent requests:</label>
                        <input type="range" id="imageConcurrencySlider" min="1" max="32" value="8">
                        <span id="imageConcurrencyValue">8</span>
                    </div>
                    <button id="processBatchImagesButton" class="button">Process Images</button>
                </div>

                <div class="batch-progress" style="display: none;">
                    <div class="progress-bar"></div>
                    <div class="progress-stats">
                        <span class="progress-text">Processing...</span>
                        <span class="progress-count">0/0</span>
                    </div>
                </div>

                <div id="batchImageResults" class="batch-results">
                    <div id="batchImageJsonResults" class="json-results"></div>
                </div>
            </div>

            <!-- ===== NEW Global Map Section ===== -->
            <div class="global-map-section" style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">üó∫Ô∏è Specimen Location Map (Last Processed)</h3>
                <div class="coord-status invalid" id="global-map-coord-status">‚ö†Ô∏è Waiting for results with coordinates...</div>
                <div id="global-map-container" style="width: 100%; height: 450px; border-radius: 8px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"></div>
           </div>
           <!-- ================================ -->

            <div class="debug-section">
                <h3>Debug Information</h3>
                <div id="debugInfo" class="logs"></div>
            </div>
        </div>
    </div>

    <!-- Include showdown.js for Markdown conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <!-- Load external scripts in the correct order -->
    <script src="js/vouchervisiongo.js"></script>
    <script src="js/api_key_validator.js"></script>
    <script src="js/batch_processing.js"></script>
    <script src="js/prompt_templates.js"></script>
    <script src="js/changelog_viewer.js"></script>

    <!-- Additional initialization script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Image preview functionality
            document.getElementById('fileInput').addEventListener('change', function (event) {
                const imagePreview = document.getElementById('imagePreview');
                if (this.files && this.files[0]) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    }

                    reader.readAsDataURL(this.files[0]);
                } else {
                    imagePreview.style.display = 'none';
                }
            });

            // Navigation functionality
            const homeLink = document.getElementById('homeLink');
            const readmeLink = document.getElementById('readmeLink');
            const promptsLink = document.getElementById('promptsLink');
            const changelogLink = document.getElementById('changelogLink');
            const signupLink = document.getElementById('signupLink');
            const mainContent = document.getElementById('mainContent');
            const readmeContent = document.getElementById('readmeContent');
            const promptsContent = document.getElementById('promptsContent');
            const changelogContent = document.getElementById('changelogContent');
            const signupContent = document.getElementById('signupContent');
            const promptsFrame = document.getElementById('promptsFrame');
            const signupFrame = document.getElementById('signupFrame');

            // Load README content
            fetch('./README.md')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    // Convert markdown to HTML
                    const converter = new showdown.Converter({
                        tables: true,
                        tasklists: true,
                        strikethrough: true,
                        ghCodeBlocks: true
                    });
                    const html = converter.makeHtml(data);
                    readmeContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching README:', error);
                    readmeContent.innerHTML = '<div class="error">Error loading README file. Please make sure README.md exists and is accessible.</div>';
                });

            // Function to reset all navigation states
            function resetNavigation() {
                // Hide all content sections
                mainContent.style.display = 'none';
                readmeContent.style.display = 'none';
                promptsContent.style.display = 'none';
                changelogContent.style.display = 'none';
                signupContent.style.display = 'none';

                // Remove active class from all nav links
                homeLink.classList.remove('active');
                readmeLink.classList.remove('active');
                promptsLink.classList.remove('active');
                changelogLink.classList.remove('active');
                signupLink.classList.remove('active');

                // Reset iframes to reduce resource usage when not visible
                promptsFrame.src = 'about:blank';
                signupFrame.src = 'about:blank';
            }

            // Handle home link click
            homeLink.addEventListener('click', function (e) {
                e.preventDefault();
                resetNavigation();
                mainContent.style.display = 'block';
                homeLink.classList.add('active');
            });

            // Handle README link click
            readmeLink.addEventListener('click', function (e) {
                e.preventDefault();
                resetNavigation();
                readmeContent.style.display = 'block';
                readmeLink.classList.add('active');
            });

            // Handle prompts link click
            promptsLink.addEventListener('click', function (e) {
                e.preventDefault();
                resetNavigation();
                promptsContent.style.display = 'block';
                promptsLink.classList.add('active');

                // Load the prompts UI in the iframe
                promptsFrame.src = 'https://vouchervision-go-738307415303.us-central1.run.app/prompts-ui';

                // Show loading indicator
                promptsContent.classList.add('loading');

                // Remove loading indicator when iframe is loaded
                promptsFrame.onload = function () {
                    promptsContent.classList.remove('loading');
                };
            });

            changelogLink.addEventListener('click', function (e) {
                e.preventDefault();
                resetNavigation();
                changelogContent.style.display = 'block';
                changelogLink.classList.add('active');
                // The changelog script will handle fetching/displaying the content
            });

            // Handle signup link click
            signupLink.addEventListener('click', function (e) {
                e.preventDefault();
                resetNavigation();
                signupContent.style.display = 'block';
                signupLink.classList.add('active');

                // Load the signup page in the iframe
                signupFrame.src = 'https://vouchervision-go-738307415303.us-central1.run.app/signup';

                // Show loading indicator
                signupContent.classList.add('loading');

                // Remove loading indicator when iframe is loaded
                signupFrame.onload = function () {
                    signupContent.classList.remove('loading');
                };
            });

            // Add manual check for LLM model selections to log them
            document.querySelectorAll('input[name="llm_model"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log(`LLM model changed to: ${this.value}`);
                    logDebug(`LLM model selection changed to: ${this.value}`);
                });
            });
        });
    </script>
    <!-- MAPBOX_TOKEN_PLACEHOLDER -->
    <script>
        // This empty script will be replaced by the server with the actual Mapbox integration
        // DO NOT MODIFY THIS COMMENT OR LINE - it's used by the server to inject the token
    </script>

        <!-- START: Embedded Mapbox Initialization Script (FINAL FIX) -->
        <script>
            (function() {
                // --- Hardcode your working Mapbox token here ---
                const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoicGh5bG9mb3JmdW4iLCJhIjoiY2xqN29rYmFiMGI0ZjNlcDFyd243eHE1aSJ9.HWBxNMKGhJ7QUx2JA2RmQg';
                // ---------------------------------------------
        
                let map = null; // Store the single map instance
                let mapboxLoaded = typeof mapboxgl !== 'undefined';
        
                function logDebug(message, ...args) { console.log(`[Map Debug] ${message}`, ...args); }
                function logError(message, ...args) { console.error(`[Map Error] ${message}`, ...args); }
        
                logDebug('Initial Mapbox GL JS loaded status:', mapboxLoaded);
        
                // --- Function to create or update the SINGLE map (NO CHANGE) ---
                function createOrUpdateGlobalMap(data) {
                    logDebug(">>> createOrUpdateGlobalMap called. Current map instance:", map ? 'Exists' : 'null');
                    const mapContainerElement = document.getElementById('global-map-container');
                    const statusElement = document.getElementById('global-map-coord-status');
        
                    if (!mapContainerElement || !statusElement) {
                        logError('Global map container or status element not found.');
                        return;
                    }
                    if (typeof mapboxgl === 'undefined') {
                            logError('Mapbox GL JS not available for global map.');
                            mapContainerElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #d32f2f;">Mapbox GL JS library not loaded.</div>';
                            return;
                    }
                    mapboxLoaded = true;
                    if (!MAPBOX_ACCESS_TOKEN) {
                            logError('Mapbox token missing for global map.');
                            mapContainerElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #d32f2f;">Mapbox token missing.</div>';
                            return;
                    }
                    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
        
                    let lat = 0, lng = 0, hasValidCoordinates = false;
                    let sourceData = data;
                    // *** FIX: Check for the full JSON response structure ***
                    if (data && data.filename) { sourceData = data; logDebug("Using data from the full API response wrapper."); }
                    const formattedJson = sourceData ? sourceData.formatted_json || null : null;
                    logDebug("Data used for coordinates:", formattedJson);
        
                    if (formattedJson && formattedJson.decimalLatitude && formattedJson.decimalLongitude) {
                        lat = parseFloat(formattedJson.decimalLatitude);
                        lng = parseFloat(formattedJson.decimalLongitude);
                        hasValidCoordinates = !isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
                        logDebug(`Parsed Coords: lat=${lat}, lng=${lng}`);
                    } else { logDebug("No valid decimalLatitude/decimalLongitude found in formattedJson."); }
                    logDebug(`Coordinate Validity Check: hasValidCoordinates = ${hasValidCoordinates}`);
        
                    statusElement.className = 'coord-status ' + (hasValidCoordinates ? 'valid' : 'invalid');
                    statusElement.innerHTML = hasValidCoordinates ? `‚úÖ Coordinates found: ${lat.toFixed(4)}, ${lng.toFixed(4)}` : (data ? '‚ö†Ô∏è No valid coordinates in last result. Showing world view.' : '‚ö†Ô∏è Waiting for results with coordinates...');
        
                    if (map && typeof map.remove === 'function') {
                            logDebug('Attempting to update existing global map.');
                            try {
                            if (map.marker) { logDebug("Removing existing marker."); map.marker.remove(); map.marker = null; }
                            else { logDebug("No existing marker to remove."); }
                            const targetCenter = hasValidCoordinates ? [lng, lat] : [0, 0];
                            const targetZoom = hasValidCoordinates ? 10 : 1;
                            logDebug(`Flying map to center: [${targetCenter.join(', ')}], zoom: ${targetZoom}`);
                            map.flyTo({ center: targetCenter, zoom: targetZoom, essential: true });
                            if (hasValidCoordinates) {
                                const popupContent = createPopupContent(formattedJson);
                                logDebug("Adding new marker.");
                                setTimeout(() => {
                                        if (map && map.addControl) {
                                            map.marker = new mapboxgl.Marker({ color: '#4CAF50' }).setLngLat([lng, lat]).setPopup(new mapboxgl.Popup().setHTML(popupContent)).addTo(map);
                                            logDebug("Marker added.");
                                        } else { logDebug("Map removed before marker could be added."); }
                                }, 50);
                            }
                                logDebug("Requesting map resize.");
                                requestAnimationFrame(() => { if (map && map.resize) map.resize(); });
                            } catch(updateError) { logError("Error during map update (flyTo/marker):", updateError); }
                    } else {
                            if (mapContainerElement.classList.contains('mapboxgl-map')) { console.warn('Global map looks initialized but instance is missing/invalid.'); return; }
                        logDebug('Creating global map (should only happen once on init)');
                        mapContainerElement.innerHTML = '';
                        try {
                            map = new mapboxgl.Map({ container: 'global-map-container', style: 'mapbox://styles/mapbox/outdoors-v12', center: [0, 0], zoom: 1 });
                            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                            map.on('load', () => {
                                logDebug('Global map loaded.');
                                if (hasValidCoordinates) {
                                        const popupContent = createPopupContent(formattedJson);
                                        map.marker = new mapboxgl.Marker({ color: '#4CAF50' }).setLngLat([lng, lat]).setPopup(new mapboxgl.Popup().setHTML(popupContent)).addTo(map);
                                }
                                requestAnimationFrame(() => { if (map && map.resize) map.resize(); });
                            });
                            map.on('error', (e) => {
                                logError('Global Mapbox error:', e);
                                mapContainerElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #d32f2f;">Error loading map: ${e.error ? e.error.message : 'Unknown error'}</div>`;
                                map = null;
                            });
                        } catch (initError) {
                            logError('Error initializing global map:', initError);
                            mapContainerElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #d32f2f;">Error initializing map: ${initError.message}</div>`;
                            map = null;
                        }
                    }
                }
        
                function createPopupContent(formattedJson) {
                    if (!formattedJson) return 'No details available.';
                    let content = `<strong>${formattedJson.scientificName || 'Unknown specimen'}</strong><br>`;
                    if (formattedJson.collectionDate) content += `Date: ${formattedJson.collectionDate}<br>`;
                    if (formattedJson.collectedBy) content += `Collector: ${formattedJson.collectedBy}<br>`;
                    if (formattedJson.locality) content += `<small>Locality: ${formattedJson.locality.substring(0, 100)}...</small>`;
                    return content;
                }
        
                function initializeGlobalMap() {
                    if (!mapboxLoaded) { console.warn('Embedded Script: Mapbox GL JS not loaded, cannot init global map yet.'); return; }
                    logDebug('Initializing global map with null data.');
                    createOrUpdateGlobalMap(null);
                }
        
                function monitorResults() {
                    logDebug('Setting up MutationObservers for results (TARGETING PARENT)');
                    const resultContainerIds = ['fileResults', 'urlResults', 'batchUrlResults', 'batchImageResults'];
                    resultContainerIds.forEach(function(containerId) {
                        const container = document.getElementById(containerId);
                        if (container) {
                            watchContainer(container);
                        } else {
                            console.warn('Embedded Script: PARENT Result container not found for monitoring:', containerId);
                        }
                    });
                }
        
                // *** FIX: Simplified the observer callback logic ***
                function watchContainer(container) {
                    const observer = new MutationObserver(function(mutationsList) {
                        // The mutation itself is the trigger. No need to inspect it deeply.
                        // The check function is robust enough to handle cases where no JSON is present.
                        logDebug("MutationObserver fired for:", container.id || container.className, ". Checking for JSON content.");
                        checkParentContainerForJson(container);
                    });
                    observer.observe(container, { childList: true, subtree: true });
                    logDebug('MutationObserver attached to PARENT:', container.id || container.className);
                }
        
                function checkParentContainerForJson(parentContainer) {
                    const jsonContentElement = parentContainer.querySelector('.json-content');
        
                    if (jsonContentElement) {
                        const contentSample = jsonContentElement.textContent.substring(0, 300);
                        logDebug(`Found .json-content inside ${parentContainer.id || parentContainer.className}. Content starts: "${contentSample}..."`);
                        setTimeout(() => {
                            try {
                                const currentContent = jsonContentElement.textContent;
                                if (!currentContent.trim()) { logDebug("JSON content is empty after delay, skipping parse."); return; }
                                const jsonData = JSON.parse(currentContent);
                                logDebug('JSON parsed successfully. Calling createOrUpdateGlobalMap.');
                                createOrUpdateGlobalMap(jsonData);
                            } catch (e) {
                                logError(`Could not parse JSON from .json-content in ${parentContainer.id || parentContainer.className}. Error:`, e);
                                logError('Problematic content:', jsonContentElement.textContent);
                            }
                        }, 50);
                    } else {
                        logDebug(`No .json-content element found inside the mutated container: ${parentContainer.id || parentContainer.className}`);
                    }
                }
        
                document.addEventListener('DOMContentLoaded', function() {
                    logDebug('DOM Loaded. Waiting slightly before Mapbox Init.');
                    setTimeout(() => {
                        logDebug('Attempting Mapbox Init after short delay.');
                        mapboxLoaded = typeof mapboxgl !== 'undefined';
                        if (!mapboxLoaded) {
                            logError("Mapbox GL JS still not loaded after delay. Global map cannot be initialized.");
                            const mapContainerElement = document.getElementById('global-map-container');
                            if(mapContainerElement) mapContainerElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #d32f2f;">Map library failed to load.</div>';
                            return;
                        }
                        if (!MAPBOX_ACCESS_TOKEN) { logWarn('No MAPBOX_ACCESS_TOKEN found (hardcoded). Map may not work.'); }
                        initializeGlobalMap();
                        monitorResults();
                    }, 150);
                });
        
            })();
            </script>
            <!-- END: Embedded Mapbox Initialization Script -->

    <!-- API Status Indicator Script -->
    <script>
    // Global flag to enable/disable the API status checker
    const ENABLE_API_CHECK = false;

    if (ENABLE_API_CHECK) {
        // --- Original API Status Checker Code ---
        (function() {
            let statusCheckInterval;
            let isCheckingStatus = false;
            
            function createStatusIndicator() {
                const statusContainer = document.createElement('div');
                statusContainer.id = 'api-status-indicator';
                statusContainer.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 255, 255, 0.95);
                    border: 1px solid #ddd;
                    border-radius: 20px;
                    padding: 8px 12px;
                    font-size: 12px;
                    font-weight: 500;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    transition: all 0.3s ease;
                    backdrop-filter: blur(5px);
                    max-width: 200px;
                    text-align: center;
                    cursor: pointer;
                `;
                
                statusContainer.addEventListener('click', function() {
                    if (!isCheckingStatus) {
                        checkAPIStatus();
                    }
                });
                
                statusContainer.title = 'Click to refresh API status';
                
                document.body.insertBefore(statusContainer, document.body.firstChild);
                
                return statusContainer;
            }
            
            function updateStatusDisplay(isAvailable, isChecking = false) {
                const container = document.getElementById('api-status-indicator');
                if (!container) return;
                
                if (isChecking) {
                    container.innerHTML = 'üîç <span style="color: #666;">Checking API...</span>';
                    container.style.borderColor = '#ccc';
                    container.style.backgroundColor = 'rgba(248, 249, 250, 0.95)';
                    return;
                }
                
                if (isAvailable) {
                    container.innerHTML = '‚úÖ <span style="color: #4CAF50;">VVGO API: Available</span>';
                    container.style.borderColor = '#4CAF50';
                    container.style.backgroundColor = 'rgba(232, 245, 233, 0.95)';
                } else {
                    container.innerHTML = 'üöß <span style="color: #FF9800;">VVGO API: Down for Maintenance</span>';
                    container.style.borderColor = '#FF9800';
                    container.style.backgroundColor = 'rgba(255, 243, 224, 0.95)';
                }
            }
            
            async function checkAPIStatus() {
                if (isCheckingStatus) return;
                
                isCheckingStatus = true;
                updateStatusDisplay(false, true);
                
                try {
                    const healthResponse = await fetch('https://vouchervision-go-738307415303.us-central1.run.app/health', {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (healthResponse.ok) {
                        const healthData = await healthResponse.json();
                        console.log('API Health Check:', healthData);
                        
                        if (healthData.maintenance_mode === true) {
                            updateStatusDisplay(false);
                            console.log('API Status: Maintenance mode active (from health check)');
                            return;
                        }
                        
                        const corsResponse = await fetch('https://vouchervision-go-738307415303.us-central1.run.app/cors-test', {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });
                        
                        if (corsResponse.status === 503) {
                            updateStatusDisplay(false);
                            console.log('API Status: Maintenance mode detected (503 from cors-test)');
                        } else if (corsResponse.ok) {
                            updateStatusDisplay(true);
                            console.log('API Status: Available');
                        } else {
                            updateStatusDisplay(true);
                            console.log('API Status: Available (cors-test returned', corsResponse.status, ')');
                        }
                    } else {
                        updateStatusDisplay(false);
                        console.log('API Status: Health check failed', healthResponse.status);
                    }
                } catch (error) {
                    updateStatusDisplay(false);
                    console.log('API Status: Network error', error.message);
                } finally {
                    isCheckingStatus = false;
                }
            }
            
            function startStatusMonitoring() {
                setTimeout(checkAPIStatus, 1500);
                statusCheckInterval = setInterval(checkAPIStatus, 30000);
                document.addEventListener('visibilitychange', function() {
                    if (!document.hidden && !isCheckingStatus) {
                        setTimeout(checkAPIStatus, 500);
                    }
                });
            }
            
            function stopStatusMonitoring() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    createStatusIndicator();
                    startStatusMonitoring();
                });
            } else {
                createStatusIndicator();
                startStatusMonitoring();
            }
            
            window.addEventListener('beforeunload', stopStatusMonitoring);
            
            window.VVGOStatus = {
                check: checkAPIStatus,
                start: startStatusMonitoring,
                stop: stopStatusMonitoring
            };
        })();
    } else {
        // --- Fallback behavior when API check is disabled ---
        document.addEventListener('DOMContentLoaded', function() {
            // Create the status indicator container
            const statusContainer = document.createElement('div');
            statusContainer.id = 'api-status-indicator';
            statusContainer.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(232, 245, 233, 0.95);
                border: 1px solid #4CAF50;
                border-radius: 20px;
                padding: 8px 12px;
                font-size: 12px;
                font-weight: 500;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                transition: all 0.3s ease;
                backdrop-filter: blur(5px);
                max-width: 200px;
                text-align: center;
            `;
            // Set a static "Available" message without performing any checks
            statusContainer.innerHTML = '‚úÖ <span style="color: #4CAF50;">VVGO API: Available</span>';
            
            // Insert at the beginning of body
            document.body.insertBefore(statusContainer, document.body.firstChild);
            
            console.log("API status check is disabled. Displaying static 'Available' indicator.");
        });
    }
    </script>

</body>
</html>